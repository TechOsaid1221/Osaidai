<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DOCX to PDF Converter & AI Assistant</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <!-- Mammoth.js for DOCX text extraction -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <!-- Markdown parser for AI response -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        body {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            /* Background is now handled by the .aesthetic-bg div below */
        }

        /* --- PERFECTLY CENTERED BACKGROUND SLOT --- */
        .aesthetic-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1; /* Behind everything */

            /* PASTE YOUR IMAGE URL HERE */
            background-image: url('anime-moon-landscape.jpg');
            
            /* Positioning & Sizing */
            background-position: center center;
            background-size: cover;
            background-repeat: no-repeat;
            
            /* Anime Aesthetic Effects */
            filter: blur(3px) brightness(0.95); /* Dreamy blur */
            transform: scale(1.05); /* Slight zoom to hide blurred edges */
        }

        .main-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem 1rem;
        }
        .card {
            border: none;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            width: 100%;
            max-width: 700px;
            overflow: hidden;
            /* Glassmorphism for the card to blend with background */
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
        }
        .card-header {
            background: rgba(52, 143, 235, 1.0);

            color: white;
            padding: 1.5rem;
            border: none;
            position: relative;
        }
        .upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 0.5rem;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            background: rgba(255, 255, 255, 0.6);
        }
        .upload-area:hover, .upload-area.dragover {
            border-color: #4a90e2;
            background-color: rgba(74, 144, 226, 0.1);
        }
        .upload-area i {
            font-size: 3rem;
            color: #adb5bd;
            margin-bottom: 1rem;
        }
        .file-info {
            display: none;
            margin-top: 1rem;
            padding: 0.75rem;
            background: rgba(233, 236, 239, 0.8);
            border-radius: 0.5rem;
            align-items: center;
            justify-content: space-between;
        }
        #fileInput {
            display: none;
        }
        .status-message {
            margin-top: 1rem;
            display: none;
        }
        .progress {
            height: 6px;
            display: none;
            margin-top: 1rem;
        }
        /* Spinner styling */
        .spinner-overlay {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        /* AI Section Styles */
        .ai-section {
            background-color: rgba(240, 247, 255, 0.7);
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-top: 1.5rem;
            display: none;
            border: 1px solid rgba(207, 226, 255, 0.8);
        }
        .ai-result-box {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
            border: 1px solid #dee2e6;
            font-size: 0.95rem;
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }
        .ai-btn-group .btn {
            font-size: 0.9rem;
        }
        /* Markdown styles */
        .ai-result-box p:last-child { margin-bottom: 0; }
        .ai-result-box ul { padding-left: 1.2rem; }
        
        .api-badge {
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 50px;
            padding: 5px 15px;
            font-size: 0.8rem;
            display: inline-flex;
            align-items: center;
            margin-top: 10px;
        }
        .navbar {
            background: rgba(255, 255, 255, 0.8) !important;
            backdrop-filter: blur(10px);
        }
    </style>
</head>
<body>

    <!-- AESTHETIC BACKGROUND SLOT -->
    <div class="aesthetic-bg"></div>

    <!-- Navbar -->
    <nav class="navbar navbar-light shadow-sm">
        <div class="container">
            <div class="d-flex align-items-center gap-2">
                <i class="bi bi-file-earmark-pdf-fill text-danger fs-2"></i>
                <div class="d-flex flex-column">
                    <span class="fw-bold h5 mb-0">Docx to PDF & AI</span>
                    <small class="text-muted" style="font-size: 0.8rem;">Created by Osaid Ur Rehman</small>
                </div>
            </div>
        </div>
    </nav>

    <div class="main-container">
        <div class="card">
            <div class="card-header text-center">
                <h4 class="mb-0 fw-bold">Convert Docx to PDF</h4>
                <p class="mb-0 opacity-75 small">Convert DOCX to PDF or analyze with Gemini AI</p>
                <div class="api-badge">
                    <i class="bi bi-check-circle-fill me-2"></i> API Connected
                </div>
            </div>

            <div class="card-body p-4">
                <!-- Upload Area -->
                <div class="upload-area" id="dropZone">
                    <i class="bi bi-cloud-arrow-up"></i>
                    <h5 class="fw-bold text-secondary">Drag & Drop DOCX here</h5>
                    <p class="text-muted small mb-0">or click to browse files</p>
                    <input type="file" id="fileInput" accept=".docx,.doc">
                </div>

                <!-- Selected File Info -->
                <div class="file-info" id="fileInfo">
                    <div class="d-flex align-items-center gap-2 overflow-hidden">
                        <i class="bi bi-file-earmark-word-fill text-primary lead"></i>
                        <span class="text-truncate fw-medium" id="fileName">filename.docx</span>
                        <span class="badge bg-secondary rounded-pill ms-2" id="fileSize">0 KB</span>
                    </div>
                    <button type="button" class="btn-close small" aria-label="Remove" id="removeFile"></button>
                </div>

                <!-- AI Section -->
                <div id="aiSection" class="ai-section">
                    <h6 class="fw-bold text-primary mb-3"><i class="bi bi-stars"></i> Ask Gemini AI</h6>
                    <p class="small text-muted mb-3">Analyze the content of your DOCX file before converting.</p>
                    
                    <div class="d-flex flex-wrap gap-2 ai-btn-group">
                        <button class="btn btn-outline-primary btn-sm" onclick="askGemini('summarize')">
                            âœ¨ Summarize
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="askGemini('insights')">
                            âœ¨ Key Insights
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="askGemini('email')">
                            âœ¨ Draft Email
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="askGemini('simplify')">
                            âœ¨ Simplify (ELI5)
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="askGemini('quiz')">
                            âœ¨ Generate Quiz
                        </button>
                    </div>

                    <div id="aiLoading" class="mt-3 d-none text-muted small">
                        <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                        Gemini is thinking...
                    </div>

                    <div id="aiResult" class="ai-result-box">
                        <!-- AI Output goes here -->
                    </div>
                </div>

                <!-- PDF Conversion Progress Bar -->
                <div class="progress" id="progressBar">
                    <div class="progress-bar progress-bar-striped progress-bar-animated bg-success" role="progressbar" style="width: 100%"></div>
                </div>

                <!-- Action Buttons -->
                <div class="d-grid gap-2 mt-4">
                    <button class="btn btn-primary btn-lg" id="convertBtn" disabled>
                        <span class="spinner-overlay" id="btnSpinner">
                            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                            Converting...
                        </span>
                        <span id="btnText">Convert to PDF</span>
                    </button>
                </div>

                <!-- Status Messages -->
                <div id="statusMessage" class="alert mt-3 status-message" role="alert"></div>

                <!-- Result Section -->
                <div id="resultSection" class="mt-3 d-none text-center p-3 bg-light rounded border border-success">
                    <i class="bi bi-check-circle-fill text-success fs-1 mb-2"></i>
                    <h5 class="fw-bold">Conversion Successful!</h5>
                    <p class="text-muted small">Your file is ready for download.</p>
                    <a href="#" id="downloadLink" class="btn btn-success w-100 shadow-sm" target="_blank">
                        <i class="bi bi-download me-2"></i>Download PDF
                    </a>
                </div>

            </div>
            <div class="card-footer bg-light text-center py-3" style="background: rgba(248, 249, 250, 0.8) !important;">
                <div class="d-flex flex-column gap-1">
                    <small class="text-muted">Powered by ConvertAPI & Gemini Itegrated</small>
                    <small class="text-primary fw-bold">Created by Osaid Ur Rehman ðŸ‡µðŸ‡°</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // DOM Elements
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const removeFileBtn = document.getElementById('removeFile');
        const convertBtn = document.getElementById('convertBtn');
        const statusMessage = document.getElementById('statusMessage');
        const progressBar = document.getElementById('progressBar');
        const btnText = document.getElementById('btnText');
        const btnSpinner = document.getElementById('btnSpinner');
        const resultSection = document.getElementById('resultSection');
        const downloadLink = document.getElementById('downloadLink');
        
        // AI DOM Elements
        const aiSection = document.getElementById('aiSection');
        const aiLoading = document.getElementById('aiLoading');
        const aiResult = document.getElementById('aiResult');

        let currentFile = null;
        let extractedText = "";
        
        // ---------------------------------------------------------
        // 1. FOR AI FEATURES (Summarize, Email, etc.)
        // NOTE: If running locally, paste your key inside the quotes below.
        // If running in the preview environment, leave it empty.
        const apiKey = "AIzaSyAeARvfTNkwyC4VGrS4_gWmA2l-wzeLieA"; 
        // ---------------------------------------------------------
        
        // ---------------------------------------------------------
        // 2. FOR PDF CONVERSION
        // Your ConvertAPI Secret is already set below:
        const convertApiSecret = "WOeP576vH1fbaVm9KuhntJzXlZQpc0vu"; 
        // ---------------------------------------------------------

        // Drag and Drop Events
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, unhighlight, false);
        });

        function highlight() {
            dropZone.classList.add('dragover');
        }

        function unhighlight() {
            dropZone.classList.remove('dragover');
        }

        dropZone.addEventListener('drop', handleDrop, false);
        dropZone.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleFiles);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            if (files.length) handleFileSelection(files[0]);
        }

        function handleFiles() {
            if (this.files.length) handleFileSelection(this.files[0]);
        }

        function handleFileSelection(file) {
            if (!file.name.match(/\.(docx|doc)$/i)) {
                showStatus('Please select a valid Word document (.docx or .doc)', 'danger');
                return;
            }

            currentFile = file;
            fileName.textContent = file.name;
            fileSize.textContent = formatBytes(file.size);
            
            // Show file info, hide upload area
            fileInfo.style.display = 'flex';
            dropZone.style.display = 'none';
            resultSection.classList.add('d-none');
            statusMessage.style.display = 'none';
            
            // Handle AI extraction for DOCX
            if (file.name.match(/\.docx$/i)) {
                extractTextFromDocx(file);
            } else {
                // .doc files cannot be parsed easily in browser
                aiSection.style.display = 'none';
                extractedText = "";
            }

            updateConvertButton();
        }

        function extractTextFromDocx(file) {
            const reader = new FileReader();
            reader.onload = function(event) {
                const arrayBuffer = event.target.result;
                mammoth.extractRawText({arrayBuffer: arrayBuffer})
                    .then(function(result){
                        extractedText = result.value;
                        // Only show AI section if text was actually found
                        if (extractedText && extractedText.trim().length > 0) {
                            aiSection.style.display = 'block';
                            aiResult.style.display = 'none';
                            aiResult.innerHTML = '';
                        }
                    })
                    .done();
            };
            reader.readAsArrayBuffer(file);
        }

        // Gemini AI Logic
        async function askGemini(type) {
            // Check if user has added their key
            if (!apiKey) {
                 aiResult.innerHTML = `<div class="alert alert-warning small mb-0">
                    <strong>Missing AI Key!</strong><br>
                    To use AI features, please open the code and paste your Google Gemini API Key into the <code>apiKey</code> variable.
                    <br><a href="https://aistudio.google.com/app/apikey" target="_blank">Get a free key here</a>
                </div>`;
                aiResult.style.display = 'block';
                return;
            }

            if (!extractedText) return;

            // UI Update
            aiLoading.classList.remove('d-none');
            aiResult.style.display = 'none';
            
            let prompt = "";
            if (type === 'summarize') {
                prompt = `Summarize the following document text in 3 clear, concise sentences:\n\n${extractedText.substring(0, 15000)}`;
            } else if (type === 'insights') {
                prompt = `Extract the top 5 key insights or bullet points from this document:\n\n${extractedText.substring(0, 15000)}`;
            } else if (type === 'email') {
                prompt = `Write a professional, polite short email draft to a colleague attaching this document. Briefly mention what the document is about based on this text:\n\n${extractedText.substring(0, 15000)}`;
            } else if (type === 'simplify') {
                prompt = `Explain the following document content like I am 5 years old. Keep it simple and fun:\n\n${extractedText.substring(0, 15000)}`;
            } else if (type === 'quiz') {
                prompt = `Generate 3 multiple-choice questions based on this document to test my understanding. Include the answers at the bottom:\n\n${extractedText.substring(0, 15000)}`;
            }

            try {
                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }]
                        })
                    }
                );

                if (!response.ok) {
                    throw new Error('AI Request failed. Check API Key.');
                }

                const data = await response.json();
                const aiText = data.candidates[0].content.parts[0].text;

                // Render Markdown
                aiResult.innerHTML = marked.parse(aiText);
                aiResult.style.display = 'block';

            } catch (error) {
                console.error(error);
                aiResult.innerHTML = `<div class="text-danger small">Failed to get AI response. Please check if your API key is correct.</div>`;
                aiResult.style.display = 'block';
            } finally {
                aiLoading.classList.add('d-none');
            }
        }

        removeFileBtn.addEventListener('click', resetFile);

        function resetFile() {
            currentFile = null;
            extractedText = "";
            fileInput.value = '';
            fileInfo.style.display = 'none';
            aiSection.style.display = 'none';
            dropZone.style.display = 'block';
            convertBtn.disabled = true;
            resultSection.classList.add('d-none');
            progressBar.style.display = 'none';
        }

        function updateConvertButton() {
            // Since API key is hardcoded, we only check for file
            convertBtn.disabled = !currentFile;
        }

        // Format bytes to readable string
        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        function showStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = `alert alert-${type} status-message`;
            statusMessage.style.display = 'block';
        }

        // PDF Conversion Logic (ConvertAPI)
        convertBtn.addEventListener('click', async () => {
            if (!currentFile) return;

            // Simple validation for the hardcoded key
            if (convertApiSecret === "YOUR_CONVERT_API_SECRET_HERE") {
                showStatus('Configuration Error: Please open the code and add your ConvertAPI Secret to the "convertApiSecret" variable.', 'warning');
                return;
            }

            const secret = convertApiSecret;
            
            // UI State: Loading
            convertBtn.disabled = true;
            btnText.style.display = 'none';
            btnSpinner.style.display = 'flex';
            progressBar.style.display = 'block';
            statusMessage.style.display = 'none';
            resultSection.classList.add('d-none');

            try {
                const formData = new FormData();
                formData.append('File', currentFile);
                formData.append('StoreFile', 'true'); // Required to get a URL back

                // Call ConvertAPI
                const response = await fetch(`https://v2.convertapi.com/convert/docx/to/pdf?Secret=${secret}`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.Message || 'Conversion failed. Please check your API Key.');
                }

                // Success
                if (data.Files && data.Files.length > 0) {
                    const pdfUrl = data.Files[0].Url;
                    downloadLink.href = pdfUrl;
                    downloadLink.setAttribute('download', data.Files[0].FileName);
                    
                    resultSection.classList.remove('d-none');
                    showStatus('File converted successfully!', 'success');
                } else {
                    throw new Error('No output file received from API.');
                }

            } catch (error) {
                showStatus(error.message, 'danger');
                console.error(error);
            } finally {
                // UI State: Reset
                convertBtn.disabled = false;
                btnText.style.display = 'inline';
                btnSpinner.style.display = 'none';
                progressBar.style.display = 'none';
            }
        });
    </script>
</body>
</html>